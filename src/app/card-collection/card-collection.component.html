<div class="collection-container">
  <!-- Collection Management Actions -->
  <div class="collection-actions">
    <div class="actions-left">
      <button (click)="exportCollection()" class="btn btn-secondary">
        üì§ Export Collection
      </button>
      <label class="btn btn-secondary import-btn">
        üì• Import Collection
        <input type="file" accept=".csv" (change)="importCollection($event)" hidden>
      </label>
      <button class="btn btn-secondary" (click)="openViewOthersModal()" [disabled]="isViewingOther">
        üë§ View Others Collection
      </button>
    </div>
    <div class="actions-right">
      <button class="btn btn-secondary" (click)="toggleViewMode()" title="Toggle view mode">
        {{ viewMode === 'grid' ? 'üìã List View' : 'üñºÔ∏è Grid View' }}
      </button>
    </div>
  </div>

  <!-- View another user's collection -->
  <div class="view-other-banner" *ngIf="isViewingOther"
    style="margin-bottom:12px; padding:10px 14px; border-radius:12px; background:rgba(46,204,113,0.12); border:1px solid rgba(46,204,113,0.35); display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <div style="background-color: transparent;">Viewing <strong>{{ viewingUser?.username }}</strong>'s collection
      (read-only)</div>
    <button class="btn btn-outline" (click)="backToMyCollection()">Back to my collection</button>
  </div>

  <!-- Filters Section (compact bar + controls) -->
  <div class="filters-panel" [class.collapsed]="!filtersOpen" role="region" aria-label="Collection filters">
    <!-- Row 1: Search only -->
    <div class="filters-row">
      <input class="filter-input" type="text" placeholder="Search cards‚Ä¶" aria-label="Search cards"
        [(ngModel)]="searchTerm" (input)="onSearchChange()" />
    </div>

    <!-- Row 2: Series + Set + Pack (pack enabled only when a set is chosen) -->
    <div class="filters-row wrap sets-row">
      <div class="sort-group">
        <label for="series-select">Series</label>
        <select id="series-select" class="filter-select compact" aria-label="Select series" [(ngModel)]="selectedSeries"
          (change)="onSeriesChange()">
          <option value="all">All Series</option>
          <option *ngFor="let series of availableSeries" [value]="series">{{ series }}</option>
        </select>
      </div>
      <div class="sort-group">
        <label for="set-select">Set {{ selectedSeries !== 'all' ? '(in ' + selectedSeries + ')' : '' }}</label>
        <select id="set-select" class="filter-select compact" aria-label="Select set" [(ngModel)]="selectedSet"
          (change)="onSetChange()">
          <option value="all">{{ selectedSeries !== 'all' ? 'All Sets in ' + selectedSeries : 'All Sets' }}</option>
          <option *ngFor="let set of availableSets" [value]="set">{{ getSetName(set) }}</option>
        </select>
      </div>
      <div class="sort-group">
        <label for="pack-select">Pack {{ selectedSet !== 'all' ? '(in ' + getSetName(selectedSet) + ')' : '(select a set
          first)' }}</label>
        <select id="pack-select" class="filter-select compact" aria-label="Select pack"
          [disabled]="selectedSet === 'all'" [(ngModel)]="selectedPack" (change)="applyFilters()">
          <option value="all">{{ selectedSet !== 'all' ? 'All Packs in ' + getSetName(selectedSet) : 'Select a set
            first' }}</option>
          <option *ngFor="let pack of availablePacks" [value]="pack">{{ pack }}</option>
        </select>
      </div>
    </div>

    <!-- Row 2: Rarity chips -->
    <div class="filters-row rarity-row">
      <label class="filter-label" for="rarity-chips">Rarity</label>
      <div id="rarity-chips" class="segmented multi chips-scroll" aria-label="Rarity filter">
        <button type="button" class="chip" [class.active]="selectedRarities.length===0" (click)="clearRarity()"
          title="All rarities">ALL</button>
        <!-- Ensure Rainbow SAR chip is visible even if data symbols are ‚òÜ‚òÜ -->
        <button type="button" class="chip" *ngIf="!hasRaritySymbol('üåà')"
          [class.active]="isRaritySelected('üåà')" (click)="toggleRarity('üåà')" [title]="'üåà - Special Art Rare'">
          üåà
        </button>
        <button type="button" class="chip" *ngFor="let group of availableRaritySymbols"
          [class.active]="isRaritySelected(group.symbol)" (click)="toggleRarity(group.symbol)"
          [title]="group.displayName">
          {{ group.symbol }}
        </button>
      </div>
    </div>

    <!-- Row 3: Types chips -->
    <div class="filters-row types-row">
      <label class="filter-label" for="types-chips">Types</label>
      <div id="types-chips" class="segmented multi chips-scroll" aria-label="Types filter">
        <button type="button" class="chip" [class.active]="selectedTypes.length===0" (click)="clearTypes()"
          title="All types">
          ALL
        </button>

        <button type="button" class="chip type-chip" *ngFor="let type of availableTypes"
          [class.active]="isTypeSelected(type)" (click)="toggleType(type)" [title]="type">

          <!-- Show text instead of image for special types -->
          <ng-container *ngIf="['Item', 'Tool', 'Supporter'].includes(type); else normalType">
            <span [ngClass]="{
              'trainer-item': type === 'Item',
              'trainer-tool': type === 'Tool',
              'trainer-supporter': type === 'Supporter'
            }" class="trainer-label">
              {{ type }}
            </span>
          </ng-container>

          <!-- Normal types (with icon image) -->
          <ng-template #normalType>
            <img [src]="'assets/energy/' + type.toLowerCase() + '.webp'" [alt]="type" class="type-icon">
          </ng-template>
        </button>
      </div>
    </div>


    <!-- Row 4: Sort + Group By + Ownership + Reset -->
    <div class="filters-row wrap">
      <div class="sort-group">
        <label for="sort-select">Sort By</label>
        <select id="sort-select" class="filter-select compact" [(ngModel)]="sortBy" (change)="applyFilters()"
          aria-label="Sort order">
          <option value="latest">Latest Set</option>
          <option value="oldest">Oldest Set</option>
        </select>
      </div>
      <div class="sort-group" *ngIf="selectedSet !== 'all'">
        <label for="group-select">Group By</label>
        <select id="group-select" class="filter-select compact" [(ngModel)]="groupBy" (change)="onGroupByChange()"
          aria-label="Group by">
          <option value="none">No Grouping</option>
          <option value="rarity">Rarity</option>
          <option value="pack">Pack</option>
          <option value="type">Type</option>
        </select>
      </div>
      <div class="segmented ownership" role="tablist" aria-label="Ownership filter">
        <button type="button" [class.active]="ownershipFilter==='all'" (click)="setOwnership('all')">ALL</button>
        <button type="button" [class.active]="ownershipFilter==='missing'"
          (click)="setOwnership('missing')">MISSING</button>
        <button type="button" [class.active]="ownershipFilter==='owned'" (click)="setOwnership('owned')">OWNED</button>
      </div>
      <div class="segmented foil" role="tablist" aria-label="Foil filter">
        <button type="button" [class.active]="foilFilter==='all'" (click)="setFoilFilter('all')">ALL</button>
        <button type="button" [class.active]="foilFilter==='no-foil'" (click)="setFoilFilter('no-foil')">NO FOIL</button>
        <button type="button" [class.active]="foilFilter==='foil-only'" (click)="setFoilFilter('foil-only')">FOIL ONLY</button>
      </div>
      <div class="row-spacer"></div>
      <button type="button" class="btn btn-outline reset-btn" (click)="clearFilters()"
        aria-label="Reset filters">Reset</button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading Pokemon cards...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-container">
    <p>{{ error }}</p>
    <button (click)="loadAllData()" class="btn btn-primary">Retry</button>
  </div>

  <!-- Sync Progress -->
  <div *ngIf="syncingCards" class="sync-progress">
    <div class="sync-message">
      <div class="sync-icon">‚è≥</div>
      <div class="sync-text">
        <div class="sync-title">{{ syncMessage }}</div>
        <div class="sync-count" *ngIf="syncProgress > 0">{{ syncProgress }} cards loaded</div>
      </div>
    </div>
  </div>

  <!-- Cards Grid with Group Headers -->
  <div *ngIf="!loading && !error" class="cards-container">
    <div *ngFor="let group of getGroupedCards(); trackBy: trackByGroupTitle" class="card-group"
      [attr.id]="'set-' + group.groupTitle">

      <!-- Group Title -->
      <div class="group-header">
        <h3 class="group-title">{{ getGroupDisplayName(group.groupTitle, group.cards) }}</h3>
        <div class="group-stats">
          <span class="group-count" style="margin-left:10px; color:#b9eaff;"
            *ngIf="getOwnedRarityCount(group.cards, '‚óä', group.groupTitle) && !getOwnedRarityCount(group.cards, '‚óä', group.groupTitle).endsWith('/0')">
            ‚óä {{ getOwnedRarityCount(group.cards, '‚óä', group.groupTitle) }}
          </span>

          <span class="group-count" style="margin-left:10px; color:#ffe066;"
            *ngIf="getOwnedRarityCount(group.cards, '‚òÜ', group.groupTitle) && !getOwnedRarityCount(group.cards, '‚òÜ', group.groupTitle).endsWith('/0')">
            ‚òÜ {{ getOwnedRarityCount(group.cards, '‚òÜ', group.groupTitle) }}
          </span>

          <span class="group-count" style="margin-left:10px; color:#f7a6ff;"
            *ngIf="getOwnedRarityCount(group.cards, '‚úµ', group.groupTitle) && !getOwnedRarityCount(group.cards, '‚úµ', group.groupTitle).endsWith('/0')">
            ‚úµ {{ getOwnedRarityCount(group.cards, '‚úµ', group.groupTitle) }}
          </span>

          <span class="group-count" style="margin-left:10px; color:#ffd700;"
            *ngIf="getOwnedRarityCount(group.cards, 'üëë', group.groupTitle) && !getOwnedRarityCount(group.cards, 'üëë', group.groupTitle).endsWith('/0')">
            üëë {{ getOwnedRarityCount(group.cards, 'üëë', group.groupTitle) }}
          </span>

          <span class="group-count">{{ getGroupCollectedCount(group.cards) }} cards</span>
        </div>
      </div>


      <!-- Cards Grid View -->
      <div *ngIf="viewMode === 'grid'" class="cards-grid">
        <div *ngFor="let card of group.cards; trackBy: trackByCardInGroup" class="card-item"
          [class.no-quantity]="getOwnedCount(card) === 0" [attr.data-cardid]="getCardId(card)">

          <!-- Card Image -->
          <div class="card-image" [class.no-quantity]="getOwnedCount(card) === 0">
            <img [src]="getCardImageUrl(getCardImageName(card))" [alt]="getCardName(card) + ' Pokemon Card'"
              class="pokemon-card-img" [class.no-quantity]="getOwnedCount(card) === 0" loading="lazy"
              (error)="onImageError($event, card)" (click)="openCardModal(card)" style="cursor: pointer;" />
          </div>

          <!-- Card Info -->
          <div class="card-info">
            <div class="card-title">{{ getCardDisplayName(card) }}</div>

            <!-- Ownership Controls -->
            <div class="ownership-controls">
              <button (click)="decreaseOwned(card)" class="count-btn decrease"
                [disabled]="isViewingOther || getOwnedCount(card) === 0">
                ‚àí
              </button>

              <ng-container *ngIf="editingCardId === getCardId(card); else displayCount">
                <input type="number" class="count-input" min="0" [(ngModel)]="editingCountValue"
                  (keydown.enter)="commitCount(card)" (keydown)="onCountInputKeydown($event, card)"
                  (keydown.escape)="cancelEditingCount()" (blur)="commitCount(card)" />
              </ng-container>

              <ng-template #displayCount>
                <button type="button" class="count-display" [disabled]="isViewingOther"
                  (click)="isViewingOther ? null : startEditingCount(card)">
                  {{ getOwnedCount(card) }}
                </button>
              </ng-template>

              <button (click)="increaseOwned(card)" class="count-btn increase" [disabled]="isViewingOther">
                +
              </button>
            </div>

            <!-- Minimum Keep Count (only show if card is owned) -->
            <div *ngIf="getOwnedCount(card) > 0 && !isViewingOther" class="minimum-keep-controls">
              <button type="button" class="lock-toggle-btn" (click)="toggleCardAllowTrade(card)" [title]="isCardAllowTrade(card) ? 'Click to lock (prevent trade)' : 'Click to unlock (allow trade)'">
                {{ isCardAllowTrade(card) ? 'üîì' : 'üîí' }}
              </button>
              <input type="number" 
                     [value]="getCardMinimumKeepCount(card)"
                     (change)="updateCardMinimumKeepCount(card, +$any($event.target).value)"
                     class="minimum-keep-input"
                     min="0"
                     [max]="getOwnedCount(card)"
                     [disabled]="isViewingOther || !isCardAllowTrade(card)"
                     placeholder="0">
            </div>
          </div>
        </div>
      </div>

      <!-- Cards List View -->
      <div *ngIf="viewMode === 'list'" class="cards-list">
        <div *ngFor="let card of group.cards; trackBy: trackByCardInGroup" class="card-list-item"
          [class.no-quantity]="getOwnedCount(card) === 0" [attr.data-cardid]="getCardId(card)">
          
          <!-- Card Image Thumbnail -->
          <div class="card-list-image" (click)="openCardModal(card)">
            <img [src]="getCardImageUrl(getCardImageName(card))" [alt]="getCardName(card) + ' Pokemon Card'"
              class="card-list-img" [class.no-quantity]="getOwnedCount(card) === 0" loading="lazy"
              (error)="onImageError($event, card)" />
          </div>

          <!-- Card Details -->
          <div class="card-list-details">
            <div class="card-list-name">{{ getCardDisplayName(card) }}</div>
            <div class="card-list-meta">
              <span class="card-list-set">{{ card.set }}-{{ card.number }}</span>
              <span *ngIf="card.packs && card.packs.length > 0" class="card-list-packs">
                {{ card.packs.join(', ') }}
              </span>
            </div>
          </div>

          <!-- Quantity Controls -->
          <div class="card-list-controls">
            <div class="card-list-quantity">
              <button (click)="decreaseOwned(card)" class="count-btn decrease"
                [disabled]="isViewingOther || getOwnedCount(card) === 0">‚àí</button>
              
              <ng-container *ngIf="editingCardId === getCardId(card); else displayCountList">
                <input type="number" class="count-input" min="0" [(ngModel)]="editingCountValue"
                  (keydown.enter)="commitCount(card)" (keydown)="onCountInputKeydown($event, card)"
                  (keydown.escape)="cancelEditingCount()" (blur)="commitCount(card)" />
              </ng-container>

              <ng-template #displayCountList>
                <button type="button" class="count-display" [disabled]="isViewingOther"
                  (click)="isViewingOther ? null : startEditingCount(card)">
                  {{ getOwnedCount(card) }}
                </button>
              </ng-template>

              <button (click)="increaseOwned(card)" class="count-btn increase" [disabled]="isViewingOther">+</button>
            </div>

            <!-- Minimum Keep in List View -->
            <div *ngIf="getOwnedCount(card) > 0 && !isViewingOther" class="card-list-keep">
              <button type="button" class="lock-toggle-btn" (click)="toggleCardAllowTrade(card)" [title]="isCardAllowTrade(card) ? 'Click to lock (prevent trade)' : 'Click to unlock (allow trade)'">
                {{ isCardAllowTrade(card) ? 'üîì' : 'üîí' }}
              </button>
              <input type="number" 
                     [value]="getCardMinimumKeepCount(card)"
                     (change)="updateCardMinimumKeepCount(card, +$any($event.target).value)"
                     class="minimum-keep-input-list"
                     min="0"
                     [max]="getOwnedCount(card)"
                     [disabled]="isViewingOther || !isCardAllowTrade(card)"
                     placeholder="0">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && !error && getGroupedCards().length === 0" class="empty-state">
    <div class="empty-icon">üîç</div>
    <h3>No cards found</h3>
    <p>Try adjusting your search or filter criteria</p>
    <button (click)="clearFilters()" class="btn btn-primary">Clear All Filters</button>
  </div>

  <!-- Floating Action Buttons: navigation -->
  <div class="fab-stack" aria-label="Collection navigation controls">
    <button type="button" class="fab" title="Top" (click)="scrollToTop()"><i class="fa fa-angle-double-up"
        aria-hidden="true"></i></button>
    <button type="button" class="fab" title="Previous set" (click)="scrollToPrevSet()"><i class="fa fa-angle-up"
        aria-hidden="true"></i></button>
    <button type="button" class="fab" title="Next set" (click)="scrollToNextSet()"><i class="fa fa-angle-down"
        aria-hidden="true"></i></button>
    <button type="button" class="fab" title="Bottom" (click)="scrollToBottom()"><i class="fa fa-angle-double-down"
        aria-hidden="true"></i></button>
  </div>

  <!-- Floating Action Button: filter toggle (mobile, bottom-left) -->
  <div class="fab-stack-left" aria-label="Filter controls">
    <button type="button" class="fab mobile-only" [attr.aria-pressed]="filtersOpen" title="Filters"
      (click)="toggleFilters()"><i class="fa fa-filter" aria-hidden="true"></i></button>
    <button type="button" class="fab mobile-only" title="View Others Collection" [disabled]="isViewingOther"
      (click)="openViewOthersModal()"><i class="fa fa-user" aria-hidden="true"></i></button>
  </div>

  <!-- View Others Collection Modal -->
  <div class="modal-backdrop" *ngIf="showViewOthersModal" (click)="closeViewOthersModal()">
    <div class="modal-content view-others-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>View Others Collection</h3>
        <button class="modal-close" (click)="closeViewOthersModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="view-others-config">
          <div class="config-section">
            <label class="config-label" for="other-username-input">Username:</label>
            <input type="text" id="other-username-input" class="config-input-wide" [(ngModel)]="otherUsername"
              placeholder="Enter username to view their collection‚Ä¶" (keydown.enter)="viewOtherCollectionFromModal()" />
            <span class="config-hint">Enter the username of the collection you want to view</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeViewOthersModal()">Cancel</button>
        <button class="btn btn-primary" (click)="viewOtherCollectionFromModal()" [disabled]="!otherUsername.trim()">
          üë§ View Collection
        </button>
      </div>
    </div>
  </div>


  <!-- Card Image Modal -->
  <div class="modal-overlay" *ngIf="selectedCardForModal" (click)="closeCardModal()">
    <div class="modal-content card-modal" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeCardModal()" aria-label="Close modal">√ó</button>
      <div class="card-modal-image" style="display: flex; align-items: center; justify-content: center; gap: 16px;">
        <button class="modal-nav-btn" (click)="showPrevCardInModal($event)" aria-label="Previous card"
          style="font-size:2rem; color: white; background:none; border:none; cursor:pointer;">
          <i class="fa fa-chevron-left" aria-hidden="true"></i>
        </button>
        <img [src]="getCardImageUrl(getCardImageName(selectedCardForModal))" [alt]="getCardDisplayName(selectedCardForModal)"
          class="modal-card-image">
        <button class="modal-nav-btn" (click)="showNextCardInModal($event)" aria-label="Next card"
          style="font-size:2rem; color: white; background:none; border:none; cursor:pointer;">
          <i class="fa fa-chevron-right" aria-hidden="true"></i>
        </button>
      </div>
      <div class="card-modal-info">
        <h3>{{ getCardDisplayName(selectedCardForModal) }}</h3>
        <div class="modal-pack-badges" *ngIf="selectedCardForModal.packs && selectedCardForModal.packs.length > 0">
          <span class="pack-badge" *ngFor="let pack of selectedCardForModal.packs">{{ pack }}</span>
        </div>
      </div>
    </div>
  </div>
</div>